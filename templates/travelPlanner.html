{% extends "base.html" %}
{% block content %}
<div class="chat-container">
  <h2 class="chat-title">Travel Itinerary Chat</h2>

  <!-- Chat box with scrollable content -->
  <div class="chat-box" id="chatBox">
    <!-- Messages will be appended here dynamically -->
  </div>

  <!-- Input container pinned at the bottom of the .chat-container -->
  <div class="input-container">
    <label for="pdfFile" class="btn file-label">ðŸ“Ž Upload PDF</label>
    <input type="file" id="pdfFile" hidden>

    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message...">
    
    <button class="send-btn" onclick="sendMessage()">Send</button>
    <button class="finalize-btn" onclick="finalizeTrip()">Finalize Trip</button>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  document.getElementById("pdfFile").addEventListener("change", uploadPDF);

  function addMessage(text, sender) {
    let chatBox = document.getElementById("chatBox");
    let messageDiv = document.createElement("div");
    messageDiv.classList.add("message", sender === "user" ? "user-message" : "bot-message");
    messageDiv.innerHTML = text;
    chatBox.appendChild(messageDiv);
    // Auto-scroll to bottom of chat
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sendMessage() {
    let userInput = document.getElementById("chatInput").value;
    if (!userInput.trim()) return;

    addMessage(userInput, "user");

    fetch("/process_text", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userInput })
    })
    .then(response => response.json())
    .then(data => {
      addMessage(data.response, "bot");
    })
    .catch(error => console.error("Error:", error));

    document.getElementById("chatInput").value = "";
  }

  function uploadPDF() {
    let fileInput = document.getElementById("pdfFile");
    let file = fileInput.files[0];
    if (!file) return;

    addMessage("ðŸ“Ž Uploaded: " + file.name, "user");

    let formData = new FormData();
    formData.append("file", file);

    fetch("/upload_pdf", {
      method: "POST",
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      addMessage(data.response, "bot");
    })
    .catch(error => console.error("Error:", error));
  }

  function finalizeTrip() {
    fetch("/finalize_trip", {
        method: "POST"
    })
    .then(response => response.json())
    .then(data => {
        // Redirect in the same window to the itinerary view.
        window.location.href = "/view_itinerary";
    })
    .catch(error => console.error("Error:", error));
  }

</script>

<style>
  /* Chat Container */
  .chat-container {
    width: 100%;
    max-width: 800px;
    background-color: #fff;
    border-radius: 10px;
    margin: 2rem auto;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    padding: 1rem 1.5rem;
    /* Make the container taller so there's space for a pinned input */
    height: 80vh;
    max-height: 80vh;
  }

  .chat-title {
    text-align: center;
    margin-bottom: 1rem;
    color: #ff6b6b;
    font-size: 1.5rem;
  }

  /* Chat Box */
  .chat-box {
    flex: 1; /* Let the chat box grow to fill space above the input */
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #fafafa;
    margin-bottom: 1rem; /* Spacing above input container */
  }

  .message {
    padding: 10px 15px;
    border-radius: 8px;
    margin: 5px 0;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.4;
  }

  .user-message {
    align-self: flex-end;
    background: #ff6b6b;
    color: #fff;
  }

  .bot-message {
    align-self: flex-start;
    background: #e9ecef;
    color: #333;
  }

  /* Input Container pinned at bottom */
  .input-container {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .file-label {
    background-color: #ffd5d5;
    color: #333;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    border: 1px solid #ffb3b3;
    transition: background-color 0.2s;
  }
  .file-label:hover {
    background-color: #ffc0c0;
  }

  .chat-input {
    flex: 1;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid #ddd;
  }

  .send-btn, .finalize-btn {
    background-color: #ff6b6b;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s;
  }
  .send-btn:hover, .finalize-btn:hover {
    background-color: #ff8080;
  }
</style>
{% endblock %}
